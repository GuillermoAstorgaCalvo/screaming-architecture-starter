---
description: 'Root repo layout and src/app composition (providers, routing, PWA)'
globs: ['**/*']
alwaysApply: false
---

## Root Repository Layout

See also: `architecture/folder-structure.mdc` (index linking adjacent rules)

```
.
├── .cursor/                          # Cursor AI rules + automation metadata
├── .docker/                          # Docker helper scripts/assets
├── .github/                          # CI (lint/test/build/Playwright/a11y) + templates
├── .lighthouserc.json                # Performance budgets for CI Lighthouse step
├── package.json                      # Scripts, engines, packageManager (pnpm via Corepack)
├── pnpm-lock.yaml                    # Locked deps
├── pnpm-workspace.yaml               # Workspace settings (onlyBuiltDependencies)
├── tsconfig.base.json                # Path aliases: @app, @core, @domains, @infra, @shared, @styles, @src-types, @tests, @e2e
├── tsconfig.{json,app.json,node.json,vitest.json,build.json}
│                                     # Project references, app, node tooling, Vitest, build declarations
├── vite.config.ts / vitest.config.ts # Vite + Vitest configs (env-aware, tsconfig paths)
├── tailwind.config.ts / postcss.config.cjs
│                                     # Tailwind v4 + PostCSS (design tokens wired through CSS variables)
├── playwright.config.ts              # Playwright (dotenv, pnpm dev server, retries, baseURL inference)
├── eslint.config.js                  # ESLint flat config (boundaries, jsx-a11y, testing-library, unicorn, security)
├── .prettierrc / .editorconfig       # Formatting baselines
├── .gitattributes / .gitignore       # Git normalization and ignores
├── .env.example / .cursorignore      # Env template + AI ignore file
├── .nvmrc / .npmrc                   # Node 22.21.1 + pnpm 10.22.0 enforcement
├── docs/                             # Markdown docs (structure, config-files, tsconfig, docker, UI customization, wizard utilities)
├── scripts/                          # Repo automation (currently `check-bundle-size.js`)
├── Dockerfile*, docker-compose*.yml  # Local + prod container setups
├── LICENSE / CODEOWNERS / SECURITY.md# Governance + disclosure
└── README.md                         # Overview + quick start (links back to docs)
```

## src/app: Application Shell

- `App.tsx`: Root component. Pure composition:
  1. `useHttpClientAuth(new JwtAuthAdapter({ storage: localStorageAdapter }))` wires AuthPort tokens into HttpPort interceptors.
  2. Providers order: `LoggerProvider` → `ErrorBoundaryWrapper` → `HttpProvider` → `AuthProvider` → `StorageProvider` → `ThemeProvider` → `I18nProvider` → `QueryProvider` → `AnalyticsProvider` → `MotionProvider` (Framer Motion layout context) → `ToastProvider` → `BrowserRouter` → `LayoutGroup` → `Router` → `ToastContainer` (inside BrowserRouter).
  3. Analytics toggles between `googleAnalyticsAdapter` and `noopAnalyticsAdapter` based on `env.ANALYTICS_ENABLED` / runtime config (prefers runtime ANALYTICS_WRITE_KEY, otherwise GA env vars).
  4. No domain logic; only composition + DI wiring.
- `main.tsx`: Bootstrap. Calls `initConfig()` from `@core/config/init` to load runtime configuration and configure httpClient baseURL. Awaits `i18nInitPromise` from `@core/i18n/i18n` to ensure translations are loaded before rendering. Calls `reportWebVitals()` from `@core/perf/reportWebVitals` with logger adapter (only runs in production). Imports domain i18n registrations (e.g., `@domains/landing/i18n`). Creates React root, renders `<App />` wrapped in `StrictMode`, imports global CSS (`@styles/globals.css`), and throws error if root element `#root` not found. Uses top-level await for async initialization.
- `router.tsx`: Centralized routes. Lazy-load pages with `React.lazy` and `React.Suspense` using `DefaultLoadingFallback` from `@core/ui/utilities/loadable/components/loadableFallback`. Uses `withTheme` HOC from `PageWrapper.tsx` to inject theme props into pages. Wraps routes with `AppLayout` component. Uses `RouteTransition` from `@core/ui/utilities/motion/components/RouteTransition` for route change animations. Tracks page views via `useAnalytics()` hook on route changes (tracks path, title, and location). Paths derive from `core/config/routes.ts` via the generated helpers in `@core/router/routes.gen` (`buildRoute`, `ROUTE_KEYS`). Includes catch-all route (`path="*"`) for `Error404`.
- `pages/*`: App-level system pages:
  - `Error404.tsx`: Not Found page (404 error)
  - `Error500.tsx`: Internal Server Error page (500 error)
- `components/*`: App-level components:
  - `AppLayout.tsx`: Layout wrapper for routes
  - `PageWrapper.tsx`: Exports `withTheme` HOC that injects theme props into page components
  - `ProtectedRoute.tsx`: Route protection component that provides authentication and permission-based route guards using route guard utilities from `@core/router/routes.guards`
- `providers/*`: App-scoped providers:
  - `ThemeProvider.tsx`: Theme management (light/dark/system) with persistence via StoragePort, system theme detection, HTML class management
  - `ThemeContext.tsx`: React context definition for theme (exports `ThemeContext` and `ThemeContextValue`)
  - `useTheme.ts`: Hook to access theme context (throws if used outside provider)
  - `I18nProvider.tsx`: Provides i18next instance to the React component tree. Wraps application with `I18nextProvider` from `react-i18next` using the configured i18n instance from `@core/i18n/i18n`.
  - `QueryProvider.tsx`: React Query client provider with optimized defaults
  - Note: Port providers (`logger/`, `http/`, `auth/`, `storage/`, `analytics/`, `toast/`, `snackbar/`) live under `core/providers/**` and are composed directly from there.

### PWA (optional)

- `app/pwa/registerSW.ts`, `app/pwa/serviceWorker.ts`: Opt-in. Disabled by default.

### Example App Composition

```tsx
// app/App.tsx (actual implementation, trimmed for clarity)
import Error500 from '@app/pages/Error500';
import { I18nProvider } from '@app/providers/I18nProvider';
import { QueryProvider } from '@app/providers/QueryProvider';
import { ThemeProvider } from '@app/providers/ThemeProvider';
import Router from '@app/router';
import { env } from '@core/config/env.client';
import { getCachedRuntimeConfig } from '@core/config/runtime';
import { useHttpClientAuth } from '@core/hooks/http/useHttpClientAuth';
import { ErrorBoundaryWrapper } from '@core/lib/ErrorBoundaryWrapper';
import { httpClient } from '@core/lib/http/httpClient';
import type { AnalyticsInitOptions } from '@core/ports/AnalyticsPort';
import { AnalyticsProvider } from '@core/providers/analytics/AnalyticsProvider';
import { AuthProvider } from '@core/providers/auth/AuthProvider';
import { HttpProvider } from '@core/providers/http/HttpProvider';
import { LoggerProvider } from '@core/providers/logger/LoggerProvider';
import { StorageProvider } from '@core/providers/storage/StorageProvider';
import { ToastProvider } from '@core/providers/toast/ToastProvider';
import ToastContainer from '@core/ui/feedback/toast/components/ToastContainer';
import { LayoutGroup } from '@core/ui/utilities/motion/components/LayoutGroup';
import { MotionProvider } from '@core/ui/utilities/motion/components/MotionProvider';
import {
	googleAnalyticsAdapter,
	noopAnalyticsAdapter,
} from '@infra/analytics/googleAnalyticsAdapter';
import { JwtAuthAdapter } from '@infra/auth/jwtAuthAdapter';
import { loggerAdapter } from '@infra/logging/loggerAdapter';
import { localStorageAdapter } from '@infra/storage/localStorageAdapter';
import { BrowserRouter } from 'react-router-dom';

const authAdapter = new JwtAuthAdapter({ storage: localStorageAdapter });

export default function App() {
	useHttpClientAuth(authAdapter);

	const analyticsEnabled = env.ANALYTICS_ENABLED;
	const analyticsAdapter = analyticsEnabled ? googleAnalyticsAdapter : noopAnalyticsAdapter;
	const analyticsConfig = getAnalyticsConfig(analyticsEnabled);

	return (
		<LoggerProvider logger={loggerAdapter}>
			<ErrorBoundaryWrapper fallback={<Error500 />}>
				<HttpProvider http={httpClient}>
					<AuthProvider auth={authAdapter}>
						<StorageProvider storage={localStorageAdapter}>
							<ThemeProvider>
								<I18nProvider>
									<QueryProvider>
										<AnalyticsProvider analytics={analyticsAdapter} config={analyticsConfig}>
											<MotionProvider reducedMotion="user">
												<ToastProvider>
													<BrowserRouter>
														<LayoutGroup id="app-route-transitions">
															<Router />
														</LayoutGroup>
													</BrowserRouter>
													<ToastContainer />
												</ToastProvider>
											</MotionProvider>
										</AnalyticsProvider>
									</QueryProvider>
								</I18nProvider>
							</ThemeProvider>
						</StorageProvider>
					</AuthProvider>
				</HttpProvider>
			</ErrorBoundaryWrapper>
		</LoggerProvider>
	);
}

function getAnalyticsConfig(isEnabled: boolean): AnalyticsInitOptions | null {
	if (!isEnabled) {
		return null;
	}
	const runtimeConfig = getCachedRuntimeConfig();
	const runtimeKey = runtimeConfig?.ANALYTICS_WRITE_KEY?.trim();
	const writeKey = runtimeKey ?? env.GA_MEASUREMENT_ID;
	if (!writeKey) {
		return null;
	}
	const config: AnalyticsInitOptions = {
		writeKey,
		dataLayerName: env.GA_DATALAYER_NAME,
	};
	if ((env.GA_DEBUG ?? env.DEV) === true) {
		config.debug = true;
	}
	return config;
}
```

### Provider Composition Order

The composition order matters:

1. `LoggerProvider` must be outermost so `ErrorBoundaryWrapper` can log failures.
2. `ErrorBoundaryWrapper` catches render errors and renders `Error500` fallback.
3. `HttpProvider` injects the httpClient (implements HttpPort) before anything that might issue requests.
4. `AuthProvider` needs to sit above any consumers of auth state (e.g., hooks/components) and before `useHttpClientAuth` attaches interceptors.
5. `StorageProvider` must wrap `ThemeProvider` (theme persistence uses `useStorage`).
6. `ThemeProvider` handles theme state + HTML class toggling.
7. `I18nProvider` exposes the configured i18n instance.
8. `QueryProvider` supplies TanStack Query client.
9. `AnalyticsProvider` injects AnalyticsPort implementation (noop vs Google Analytics).
10. `MotionProvider` controls reduced-motion + provides `LayoutGroup`.
11. `ToastProvider` manages toast queue; `ToastContainer` must render inside it.
12. `BrowserRouter` enables routing; `LayoutGroup` wraps `Router` for motion transitions.
13. `Router` renders domain routes; `ToastContainer` renders notifications.

### Routing Principles

- Route objects live in each domain and are aggregated in `app/router.tsx`.
- Prefer route-level code-splitting via `React.lazy` and `Suspense`.
- Define path segments in `core/config/routes.ts`; avoid string literals in pages.

### Cross-References

- Folder overview and boundaries: `architecture/folder-structure.mdc`, `boundaries.mdc`
- Providers guidance: `config/providers.mdc`
- Routing specifics: `config/routing.mdc`
- State management: `architecture/state.mdc`
